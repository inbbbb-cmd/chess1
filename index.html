<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Шахматы Pro</title>
    
    <!-- Стили: Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Библиотеки (CDNJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            background-color: #1a202c;
            color: #e2e8f0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overscroll-behavior: none;
        }
        #myBoard {
            width: 100%;
            margin: 0 auto;
            touch-action: none; 
        }
        #myBoard img {
            max-width: 100%;
            display: block;
        }
        @media (max-width: 600px) {
            #myBoard {
                max-width: 90vw;
            }
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Заголовок -->
    <header class="text-center mb-6">
        <h1 class="text-4xl font-bold text-yellow-500 mb-2"><i class="fas fa-chess"></i> Шахматы</h1>
        <p class="text-gray-400 text-sm">Одиночная игра или Онлайн</p>
    </header>

    <!-- Основной контейнер -->
    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-4xl flex flex-col md:flex-row gap-8">
        
        <!-- Левая колонка: Доска -->
        <div class="flex-1 flex flex-col items-center justify-start w-full">
            <div id="status" class="w-full text-center mb-4 text-lg font-semibold text-white bg-gray-700 py-2 rounded transition-colors duration-300">
                Загрузка...
            </div>
            
            <div id="error-box" class="hidden w-full bg-red-900 border border-red-500 text-white p-4 rounded mb-4 text-sm">
                <p class="font-bold">Ошибка загрузки:</p>
                <ul id="missing-libs" class="list-disc pl-5 mt-1"></ul>
            </div>

            <div class="w-full max-w-[500px] aspect-square bg-gray-700 rounded shadow-inner flex items-center justify-center overflow-hidden relative">
                <div id="myBoard" class="w-full z-10"></div>
                <div id="board-placeholder" class="absolute inset-0 flex items-center justify-center text-gray-500 z-0">
                    <i class="fas fa-chess-board text-6xl opacity-20"></i>
                </div>
            </div>

            <div class="mt-4 flex justify-between w-full max-w-[500px] text-sm text-gray-400">
                <span id="player-color-display">Вы играете за: Белых</span>
            </div>
        </div>

        <!-- Правая колонка: Управление -->
        <div class="w-full md:w-80 flex flex-col gap-4">
            
            <div class="bg-gray-700 p-4 rounded-lg">
                <h2 class="text-xl font-bold mb-4 border-b border-gray-600 pb-2">Настройки игры</h2>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Режим:</label>
                    <select id="gameMode" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white focus:outline-none focus:border-yellow-500 transition">
                        <option value="ai">Против компьютера</option>
                        <option value="multiplayer">Онлайн (Мультиплеер)</option>
                    </select>
                </div>

                <!-- Настройки AI -->
                <div id="ai-controls">
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Сложность:</label>
                        <select id="difficulty" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white">
                            <option value="1">Легкий (Новичок)</option>
                            <option value="2" selected>Средний (Любитель)</option>
                            <option value="3">Сложный (Мастер)</option>
                        </select>
                    </div>
                    <button id="startAiGame" class="w-full bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-2 px-4 rounded transition active:scale-95 shadow-lg border-b-4 border-yellow-700 hover:border-yellow-600">
                        <i class="fas fa-play mr-2"></i> Новая игра
                    </button>
                </div>

                <!-- Настройки Мультиплеера -->
                <div id="multiplayer-controls" class="hidden">
                    <div class="mb-4">
                        <p class="text-xs text-gray-400 mb-2">Для игры с другом используйте ID комнаты.</p>
                        <div class="flex gap-2 mb-2">
                            <button id="createGameBtn" class="flex-1 bg-green-600 hover:bg-green-500 py-2 rounded text-sm font-bold transition shadow border-b-4 border-green-800 active:border-0 active:translate-y-1">Создать</button>
                            <button id="joinGameBtn" class="flex-1 bg-blue-600 hover:bg-blue-500 py-2 rounded text-sm font-bold transition shadow border-b-4 border-blue-800 active:border-0 active:translate-y-1">Войти</button>
                        </div>
                        
                        <!-- Индикатор статуса подключения (для ТГ) -->
                        <div id="connection-status" class="text-xs text-yellow-500 mb-2 hidden"><i class="fas fa-circle-notch fa-spin"></i> Подключение к серверу...</div>

                        <div id="room-input-container" class="hidden animate-fade-in">
                            <input type="text" id="roomIdInput" placeholder="Введите ID комнаты" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white mb-2 text-center uppercase tracking-widest">
                            <button id="confirmJoinBtn" class="w-full bg-blue-600 hover:bg-blue-500 py-2 rounded text-sm font-bold">Подключиться</button>
                        </div>
                        <div id="room-display-container" class="hidden bg-gray-900 p-3 rounded text-center border border-yellow-500 border-dashed animate-pulse-once">
                            <p class="text-xs text-gray-400">Ваш ID комнаты:</p>
                            <div class="text-xl font-mono font-bold text-yellow-500 select-all cursor-pointer hover:text-white" id="currentRoomId" onclick="copyToClipboard(this.innerText)">---</div>
                            <p class="text-[10px] text-gray-500 mt-1">Нажмите, чтобы скопировать</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Лог -->
            <div class="bg-gray-700 p-4 rounded-lg flex-1 overflow-hidden flex flex-col min-h-[200px]">
                <h3 class="font-bold mb-2 text-sm text-gray-300">История ходов</h3>
                <div id="pgn-log" class="flex-1 overflow-y-auto text-sm font-mono bg-gray-900 p-2 rounded text-gray-400 border border-gray-600">
                    Ожидание...
                </div>
            </div>

            <button id="resetBtn" class="w-full border border-red-500 text-red-500 hover:bg-red-500 hover:text-white py-2 rounded transition text-sm">
                Сбросить доску
            </button>
        </div>
    </div>

    <!-- Модальное окно -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 p-6 rounded-lg max-w-sm w-full text-center border border-gray-600 shadow-2xl transform transition-all scale-100">
            <h3 id="modal-title" class="text-xl font-bold mb-2 text-white">Сообщение</h3>
            <p id="modal-msg" class="text-gray-300 mb-6">...</p>
            <button onclick="closeModal()" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded transition">Понятно</button>
        </div>
    </div>

    <div id="toast" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-yellow-600 text-white px-6 py-3 rounded-full shadow-lg transition-opacity duration-500 opacity-0 pointer-events-none z-50 font-bold">
        Игра началась! Ваш ход.
    </div>

    <script>
        function checkLibraries() {
            var missing = [];
            if (typeof jQuery === 'undefined') missing.push('jQuery');
            if (typeof Chess === 'undefined') missing.push('Chess.js');
            if (typeof Chessboard === 'undefined') missing.push('Chessboard.js');
            
            if (missing.length > 0) {
                var list = document.getElementById('missing-libs');
                missing.forEach(function(lib) {
                    var li = document.createElement('li');
                    li.textContent = lib;
                    list.appendChild(li);
                });
                document.getElementById('error-box').classList.remove('hidden');
                document.getElementById('status').textContent = "Ошибка библиотек";
                document.getElementById('status').classList.add('bg-red-600');
            }
        }

        var board = null;
        var game = null;
        var isAiMode = true;
        var aiDepth = 2;
        var currentRoom = null;
        var playerColor = 'w';
        var firebaseAvailable = false;
        
        var firebaseActions = {
            createGame: async () => showModal('Подождите', 'Модуль онлайн игры подключается...'),
            joinGame: async () => showModal('Подождите', 'Модуль онлайн игры подключается...'),
            sendMove: async (fen) => console.log('Offline move')
        };

        window.onload = function() {
            try {
                checkLibraries();
                game = new Chess();
                
                var config = {
                    draggable: true,
                    position: 'start',
                    onDragStart: onDragStart,
                    onDrop: onDrop,
                    onSnapEnd: onSnapEnd,
                    pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
                };
                
                board = Chessboard('myBoard', config);
                $(window).resize(board.resize);
                setTimeout(() => { if(board) board.resize(); }, 500);

                updateStatus();
                
                $('#gameMode').change(onModeChange);
                $('#startAiGame').click(startAiGame);
                $('#resetBtn').click(resetBoardAction);
                $('#createGameBtn').click(function() { firebaseActions.createGame() });
                $('#joinGameBtn').click(showJoinInput);
                $('#confirmJoinBtn').click(function() { firebaseActions.joinGame() });

                $('#status').text("Готово к игре!");

            } catch (err) {
                console.error("Init Error:", err);
            }
        };

        function onModeChange() {
            const mode = $(this).val();
            if (mode === 'ai') {
                $('#ai-controls').removeClass('hidden');
                $('#multiplayer-controls').addClass('hidden');
                isAiMode = true;
                currentRoom = null;
                resetGame();
            } else {
                $('#ai-controls').addClass('hidden');
                $('#multiplayer-controls').removeClass('hidden');
                isAiMode = false;
                resetGame();
                if (!firebaseAvailable) {
                    $('#connection-status').removeClass('hidden');
                }
            }
        }

        function startAiGame() {
            aiDepth = parseInt($('#difficulty').val());
            resetGame();
            showToast("Игра началась! Ваш ход (Белые)");
        }

        function resetBoardAction() {
            resetGame();
            showToast("Доска сброшена");
        }

        function showJoinInput() {
            $('#room-input-container').removeClass('hidden');
            $('#createGameBtn').addClass('opacity-50 cursor-not-allowed').prop('disabled', true);
            $('#joinGameBtn').removeClass('opacity-50');
        }

        function onDragStart(source, piece, position, orientation) {
            if (!game || game.game_over()) return false;
            if (isAiMode) {
                if (piece.search(/^b/) !== -1) return false;
            } else {
                if ((orientation === 'white' && piece.search(/^w/) === -1) ||
                    (orientation === 'black' && piece.search(/^b/) === -1)) return false;
                if ((game.turn() === 'w' && orientation !== 'white') ||
                    (game.turn() === 'b' && orientation !== 'black')) return false;
            }
        }

        function onDrop(source, target) {
            var move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';
            updateStatus();
            updateLog();

            if (isAiMode) {
                window.setTimeout(makeAiMove, 250);
            } else {
                if (currentRoom) firebaseActions.sendMove(game.fen());
            }
        }

        function onSnapEnd() {
            if (board && game) board.position(game.fen());
        }

        function updateStatus() {
            if (!game) return;
            var status = '';
            var moveColor = (game.turn() === 'w') ? 'Белых' : 'Черных';

            if (game.in_checkmate()) {
                status = 'Мат! Победили ' + (game.turn() === 'w' ? 'Черные' : 'Белые');
                showModal('Игра окончена', status);
            } else if (game.in_draw()) {
                status = 'Ничья!';
                showModal('Игра окончена', 'Ничья');
            } else {
                status = 'Ход ' + moveColor;
                if (game.in_check()) status += ', Шах!';
            }

            $('#status').text(status);
            if(game.turn() === 'w') {
                $('#status').removeClass('bg-gray-900 text-white').addClass('bg-gray-200 text-gray-900');
            } else {
                $('#status').removeClass('bg-gray-200 text-gray-900').addClass('bg-gray-900 text-white');
            }
        }

        function updateLog() {
            $('#pgn-log').text(game.pgn() || "Новая партия.");
            var logDiv = document.getElementById("pgn-log");
            if (logDiv) logDiv.scrollTop = logDiv.scrollHeight;
        }

        function resetGame() {
            if (game) game.reset();
            if (board) {
                board.start();
                board.orientation('white'); 
            }
            $('#player-color-display').text("Вы играете за: Белых");
            updateStatus();
            $('#pgn-log').text('Новая игра...');
        }

        function makeAiMove() {
            if (game.game_over()) return;
            var depth = aiDepth; 
            if (aiDepth === 1) depth = 1;

            var bestMove = minimaxRoot(depth, game, true);
            if (!bestMove) {
                 var moves = game.moves();
                 if(moves.length > 0) bestMove = moves[Math.floor(Math.random() * moves.length)];
            }

            if(bestMove) {
                game.move(bestMove);
                board.position(game.fen());
                updateStatus();
                updateLog();
            }
        }

        function minimaxRoot(depth, game, isMaximisingPlayer) {
            var newGameMoves = game.moves();
            if (aiDepth === 1 && Math.random() < 0.35 && newGameMoves.length > 0) {
                return newGameMoves[Math.floor(Math.random() * newGameMoves.length)];
            }
            var bestMove = -9999;
            var bestMoveFound = null;

            for(var i = 0; i < newGameMoves.length; i++) {
                var newGameMove = newGameMoves[i];
                game.move(newGameMove);
                var value = minimax(depth - 1, game, -10000, 10000, !isMaximisingPlayer);
                game.undo();
                if(value >= bestMove) {
                    bestMove = value;
                    bestMoveFound = newGameMove;
                }
            }
            return bestMoveFound || (newGameMoves.length > 0 ? newGameMoves[0] : null);
        }

        function minimax(depth, game, alpha, beta, isMaximisingPlayer) {
            if (depth === 0) return -evaluateBoard(game.board());

            var newGameMoves = game.moves();
            if (newGameMoves.length === 0) {
                if (game.in_checkmate()) return isMaximisingPlayer ? -10000 : 10000;
                return 0;
            }

            if (isMaximisingPlayer) {
                var bestMove = -9999;
                for (var i = 0; i < newGameMoves.length; i++) {
                    game.move(newGameMoves[i]);
                    bestMove = Math.max(bestMove, minimax(depth - 1, game, alpha, beta, !isMaximisingPlayer));
                    game.undo();
                    alpha = Math.max(alpha, bestMove);
                    if (beta <= alpha) return bestMove;
                }
                return bestMove;
            } else {
                var bestMove = 9999;
                for (var i = 0; i < newGameMoves.length; i++) {
                    game.move(newGameMoves[i]);
                    bestMove = Math.min(bestMove, minimax(depth - 1, game, alpha, beta, !isMaximisingPlayer));
                    game.undo();
                    beta = Math.min(beta, bestMove);
                    if (beta <= alpha) return bestMove;
                }
                return bestMove;
            }
        }

        function evaluateBoard(board) {
            var totalEvaluation = 0;
            for (var i = 0; i < 8; i++) {
                for (var j = 0; j < 8; j++) {
                    totalEvaluation = totalEvaluation + getPieceValue(board[i][j], i, j);
                }
            }
            return totalEvaluation;
        }

        function getPieceValue(piece, x, y) {
            if (piece === null) return 0;
            var getAbsoluteValue = function (piece, isWhite, x ,y) {
                if (piece.type === 'p') return 10 + ( isWhite ? pawnEvalWhite[y][x] : pawnEvalBlack[y][x] );
                if (piece.type === 'r') return 50 + ( isWhite ? rookEvalWhite[y][x] : rookEvalBlack[y][x] );
                if (piece.type === 'n') return 30 + knightEval[y][x];
                if (piece.type === 'b') return 30 + ( isWhite ? bishopEvalWhite[y][x] : bishopEvalBlack[y][x] );
                if (piece.type === 'q') return 90 + evalQueen[y][x];
                if (piece.type === 'k') return 900 + ( isWhite ? kingEvalWhite[y][x] : kingEvalBlack[y][x] );
                return 0;
            };
            var absoluteValue = getAbsoluteValue(piece, piece.color === 'w', x ,y);
            return piece.color === 'w' ? absoluteValue : -absoluteValue;
        }

        var pawnEvalWhite = [[0,0,0,0,0,0,0,0],[5,5,5,5,5,5,5,5],[1,1,2,3,3,2,1,1],[0.5,0.5,1,2.5,2.5,1,0.5,0.5],[0,0,0,2,2,0,0,0],[0.5,-0.5,-1,0,0,-1,-0.5,0.5],[0.5,1,1,-2,-2,1,1,0.5],[0,0,0,0,0,0,0,0]];
        var pawnEvalBlack = pawnEvalWhite.slice().reverse();
        var knightEval = [[-5,-4,-3,-3,-3,-3,-4,-5],[-4,-2,0,0,0,0,-2,-4],[-3,0,1,1.5,1.5,1,0,-3],[-3,0.5,1.5,2,2,1.5,0.5,-3],[-3,0,1.5,2,2,1.5,0,-3],[-3,0.5,1,1.5,1.5,1,0.5,-3],[-4,-2,0,0.5,0.5,0,-2,-4],[-5,-4,-3,-3,-3,-3,-4,-5]];
        var bishopEvalWhite = [[-2,-1,-1,-1,-1,-1,-1,-2],[-1,0,0,0,0,0,0,-1],[-1,0,0.5,1,1,0.5,0,-1],[-1,0.5,0.5,1,1,0.5,0.5,-1],[-1,0,1,1,1,1,0,-1],[-1,1,1,1,1,1,1,-1],[-1,0.5,0,0,0,0,0.5,-1],[-2,-1,-1,-1,-1,-1,-1,-2]];
        var bishopEvalBlack = bishopEvalWhite.slice().reverse();
        var rookEvalWhite = [[0,0,0,0,0,0,0,0],[0.5,1,1,1,1,1,1,0.5],[-0.5,0,0,0,0,0,0,-0.5],[-0.5,0,0,0,0,0,0,-0.5],[-0.5,0,0,0,0,0,0,-0.5],[-0.5,0,0,0,0,0,0,-0.5],[-0.5,0,0,0,0,0,0,-0.5],[0,0,0,0.5,0.5,0,0,0]];
        var rookEvalBlack = rookEvalWhite.slice().reverse();
        var evalQueen = [[-2,-1,-1,-0.5,-0.5,-1,-1,-2],[-1,0,0,0,0,0,0,-1],[-1,0,0.5,0.5,0.5,0.5,0,-1],[-0.5,0,0.5,0.5,0.5,0.5,0,-0.5],[0,0,0.5,0.5,0.5,0.5,0,-0.5],[-1,0.5,0.5,0.5,0.5,0.5,0,-1],[-1,0,0.5,0,0,0,0,-1],[-2,-1,-1,-0.5,-0.5,-1,-1,-2]];
        var kingEvalWhite = [[-3,-4,-4,-5,-5,-4,-4,-3],[-3,-4,-4,-5,-5,-4,-4,-3],[-3,-4,-4,-5,-5,-4,-4,-3],[-3,-4,-4,-5,-5,-4,-4,-3],[-2,-3,-3,-4,-4,-3,-3,-2],[-1,-2,-2,-2,-2,-2,-2,-1],[2,2,0,0,0,0,2,2],[2,3,1,0,0,1,3,2]];
        var kingEvalBlack = kingEvalWhite.slice().reverse();

        window.closeModal = function() { $('#modal').addClass('hidden'); }
        window.showModal = function(title, msg) { $('#modal-title').text(title); $('#modal-msg').text(msg); $('#modal').removeClass('hidden'); }
        window.showToast = function(msg) { const t = $('#toast'); t.text(msg); t.removeClass('opacity-0').addClass('opacity-100'); setTimeout(() => { t.removeClass('opacity-100').addClass('opacity-0'); }, 3000); }
        window.copyToClipboard = function(text) { const el = document.createElement('textarea'); el.value = text; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); showToast('ID скопирован: ' + text); }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, inMemoryPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        (async function initFirebase() {
            try {
                let configStr = new URLSearchParams(window.location.search).get('firebase_config');
                if (!configStr && typeof __firebase_config !== 'undefined') configStr = __firebase_config;
                if (!configStr) throw new Error("Нет конфигурации");

                const app = initializeApp(JSON.parse(configStr));
                const auth = getAuth(app);
                const db = getFirestore(app);
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'chess-game';
                
                let currentUser = null;
                let unsubscribeRoom = null;

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        firebaseAvailable = true;
                        $('#connection-status').addClass('hidden');
                        console.log("Онлайн модуль готов (UID: " + user.uid + ")");
                    }
                });
                
                // ТАЙМАУТ ПОДКЛЮЧЕНИЯ (Для ТГ)
                const connectionTimeout = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error("Timeout")), 7000)
                );

                try {
                    // Попытка авторизации
                    const authPromise = (typeof __initial_auth_token !== 'undefined' && __initial_auth_token)
                        ? signInWithCustomToken(auth, __initial_auth_token)
                        : signInAnonymously(auth);

                    await Promise.race([authPromise, connectionTimeout]);

                } catch (err) {
                    console.warn("Standard Auth failed/timeout, trying InMemory:", err);
                    // ФОЛЛБЭК ДЛЯ TELEGRAM/INSTAGRAM WEBVIEW
                    // Если обычный вход завис или упал, пробуем без сохранения сессии
                    try {
                        await setPersistence(auth, inMemoryPersistence);
                        await signInAnonymously(auth);
                    } catch (err2) {
                        console.error("Critical Auth Error:", err2);
                        // Если и это не помогло, переопределяем кнопки на ошибку
                        window.firebaseActions.createGame = async () => showModal('Ошибка', 'Онлайн недоступен в этом браузере.');
                        window.firebaseActions.joinGame = async () => showModal('Ошибка', 'Онлайн недоступен в этом браузере.');
                        $('#connection-status').text("Ошибка подключения (Offline)").addClass('text-red-500').removeClass('hidden text-yellow-500');
                        return;
                    }
                }

                window.firebaseActions.createGame = async function() {
                    if (!currentUser) { showModal('Ошибка', 'Нет соединения.'); return; }
                    const roomId = Math.random().toString(36).substring(2, 7).toUpperCase();
                    const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', roomId);
                    
                    try {
                        showToast("Создание...");
                        await setDoc(gameRef, { fen: 'start', createdAt: new Date(), host: currentUser.uid, status: 'waiting' });
                        currentRoom = roomId;
                        playerColor = 'white';
                        
                        $('#room-display-container').removeClass('hidden');
                        $('#currentRoomId').text(roomId);
                        $('#createGameBtn').addClass('bg-gray-600').prop('disabled', true);
                        $('#player-color-display').text("Белые (Ждем соперника...)");
                        
                        resetGame();
                        listenToGame(roomId);
                        showToast("Комната: " + roomId);
                    } catch (e) { showModal('Ошибка', e.message); }
                };

                window.firebaseActions.joinGame = async function() {
                    if (!currentUser) { showModal('Ошибка', 'Нет соединения.'); return; }
                    const inputId = $('#roomIdInput').val().trim().toUpperCase();
                    if (inputId.length < 3) return;

                    const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', inputId);
                    try {
                        const snap = await getDoc(gameRef);
                        if (snap.exists()) {
                            currentRoom = inputId;
                            playerColor = 'black';
                            $('#room-input-container').addClass('hidden');
                            $('#room-display-container').removeClass('hidden');
                            $('#currentRoomId').text(inputId);
                            $('#player-color-display').text("Вы за Черных");
                            board.orientation('black');
                            await updateDoc(gameRef, { status: 'active', guest: currentUser.uid });
                            listenToGame(inputId);
                            showToast("Подключено!");
                        } else { showModal('Ошибка', 'Комната не найдена'); }
                    } catch (e) { showModal('Ошибка', e.message); }
                };

                window.firebaseActions.sendMove = async function(fen) {
                    if (!currentRoom) return;
                    const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', currentRoom);
                    await updateDoc(gameRef, { fen: fen, lastMoveTime: new Date() }).catch(e => console.log(e));
                };

                function listenToGame(roomId) {
                    const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', roomId);
                    if (unsubscribeRoom) unsubscribeRoom();
                    unsubscribeRoom = onSnapshot(gameRef, (doc) => {
                        if (!doc.exists()) return;
                        const data = doc.data();
                        if (data.fen && data.fen !== game.fen()) {
                            game.load(data.fen);
                            board.position(data.fen);
                            updateStatus();
                            updateLog();
                            showToast("Ход соперника");
                        }
                        if (playerColor === 'white' && data.status === 'active') {
                             $('#player-color-display').text("Вы за Белых (Соперник тут)");
                        }
                    });
                }

            } catch (err) {
                console.warn("Firebase Init Error (Offline Mode):", err);
            }
        })();
    </script>
</body>
</html>
